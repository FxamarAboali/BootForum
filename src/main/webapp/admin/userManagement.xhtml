<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:p="http://primefaces.org/ui"
    xmlns:jsf="http://xmlns.jcp.org/jsf" 
    template="/WEB-INF/template/layout_admin.xhtml">

	<ui:define name="title">
		#{msg['application.title']} Administration - Manage Users
	</ui:define>
	
	<ui:define name="content">
		
		<div class="w3-panel w3-card-4 w3-margin-top w3-padding w3-white">

			<p:messages id="messages" showDetail="true">
				<p:autoUpdate/>
			</p:messages>

			<div class="w3-panel w3-theme-d5 w3-center w3-round">
 				<h2>#{msg['userManagement.page.title']}</h2>
 			</div>
		
			<p/>
			
			<h:form id="form">
			
				<p:dataTable var="user" value="#{userManagement.lazyModel}" style="margin: 0 auto;"
					widgetVar="userTableVar" rowIndexVar="rowIndex" paginator="true" reflow="true"
					rows="25" lazy="true" id="userTable" filterEvent="enter" 
					paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
					currentPageReportTemplate="Number of Records: ({totalRecords})"
					rowsPerPageTemplate="1, 15,25,100" editable="true" draggableColumns="true">
	
					<f:facet name="footer">
						<!-- Note: use div class w3-theme-* and style margin of negative values to cover the default 
							background color of Primefaces datatable color header/footer 
						-->
						<div class="w3-theme-l2 w3-round-small" style="margin:-9px -15px -9px -15px; padding: 16px">
							<!-- the following outputText is for Excel export sheet's name -->
							<h:outputText value="Data" style="display:none" />
		
							<p:commandButton value="&#160;Export as Excel" ajax="false" icon="fa fa-table">
		
								<p:dataExporter type="xls" target="userTable"
									fileName="UserData" />
							</p:commandButton>
						</div>
						
					</f:facet>
		       		
					<p:column sortBy="#{user.username}" filterBy="#{user.username}">
						<f:facet name="header">
							<h:outputText value="User Name" style="font-weight:bold;"/>
						</f:facet>
						<h:outputText value="#{user.username}" />
					</p:column>
		
					<p:column sortBy="#{user.person.firstName}" filterBy="#{user.person.firstName}">
						<f:facet name="header">
							<h:outputText value="First Name" style="font-weight:bold;"/>
						</f:facet>
						<h:outputText value="#{user.person.firstName}" />
					</p:column>
		
					<p:column sortBy="#{user.person.lastName}" filterBy="#{user.person.lastName}">
						<f:facet name="header">
							<h:outputText value="Last Name" style="font-weight:bold;"/>
						</f:facet>
						<h:outputText value="#{user.person.lastName}" />
					</p:column>
		
					<p:column sortBy="#{user.person.email}" filterBy="#{user.person.email}">
						<f:facet name="header">
							<h:outputText value="Email Address" style="font-weight:bold;"/>
						</f:facet>
						<h:outputText value="#{user.person.email}" />
					</p:column>
					
					<p:column sortBy="#{user.accountStatus}" filterBy="#{user.accountStatus}">
						<f:facet name="header">
							<h:outputText value="Account Active" style="font-weight:bold;"/>
						</f:facet>

						<f:facet name="filter">
			      			<p:selectOneMenu onchange="PF('userTableVar').filter()">
			      				<f:converter converterId="accountStatusConverter"/>
								<f:selectItems value="#{referenceData.accountStatuses}" var="status" itemValue="#{status}" itemLabel="#{status.name}"/>
							</p:selectOneMenu>
		            	</f:facet>
		            						
						<h:outputText value="#{user.accountStatus == 'ACTIVE' ? 'Yes' : 'No'}" />
					</p:column>

					<p:column exportable="false"
						style="vertical-align:middle;width:50px;text-align:center;">
						
						<f:facet name="header">
							<h:outputText value="Edit" style="font-weight:bold;"/>
						</f:facet>
						
						<p:commandButton update=":editModal" 
							oncomplete="document.getElementById('editModal').style.display='block'" 
							icon="fa fa-edit" title="Edit">
							<f:setPropertyActionListener value="#{user}" target="#{userManagement.selectedRecord}" />
						</p:commandButton>
						
						<!-- <p:commandButton oncomplete="PF('confirmDeleteDialogVar').show()"
							icon="fa fa-times" title="Delete">
							<f:setPropertyActionListener value="#{user}" target="#{userManagement.deleteRecord}" />
						</p:commandButton> -->
					</p:column>
					
		       	</p:dataTable>
			
			</h:form>
	    
		</div>

		<!-- The Modal -->
		<h:panelGroup layout="block" id="editModal" styleClass="w3-modal">
			
			<div class="w3-modal-content w3-animate-right">
			
				<header class="w3-container w3-theme-d3">
		        	<h3>Edit user '#{userManagement.selectedRecord.username}'</h3>
		        	
		        	<span onclick="document.getElementById('editModal').style.display='none'" 
		      			class="w3-button w3-display-topright w3-xlarge">&times;</span>
		        </header>
			
		    	<div class="w3-container">
		      		
						
					<h:form id="editForm" rendered="#{userManagement.selectedRecord != null}">
				       
				        
				        <div class="w3-card-2 w3-margin-top">
				  			
				  			<h:panelGrid columns="2" cellspacing="10">
				  			
				  				<h:outputText value="Avatar:"/>
								
								<h:graphicImage value="data:image/png;base64,#{fileHandler.getAvatarBase64(userManagement.selectedRecord.username)}"
									id="avatarImage" height="60" width="60" style="border:3px;"/>
								
		 		  				<h:outputText value="Username:"/>
				  				<h:outputText value="#{userManagement.selectedRecord.username}"/>
				  				
				  				<h:outputText value="First Name:"/>
				  				<h:outputText value="#{userManagement.selectedRecord.person.firstName}"/>
				  				
				  				<h:outputText value="Last Name:"/>
				  				<h:outputText value="#{userManagement.selectedRecord.person.lastName}"/>
				  				
				  				<h:outputText value="Email:"/>
				  				<h:outputText value="#{userManagement.selectedRecord.person.email}"/>
				  				
		 		  				<h:outputLabel value="Account Status" for="accountStatus"/>						
								<p:selectOneMenu value="#{userManagement.selectedRecord.accountStatus}" id="accountStatus">
									<f:selectItems value="#{referenceData.accountStatuses}" var="status" itemValue="#{status}" itemLabel="#{status.name}"/>
									<!-- If we want ajax update, can use the p:ajax event="change" as below to initiate call to server side action -->
									<!-- <p:ajax event="change" listener="#{userManagement.updateAccountStatus}" update=":form:userTable"></p:ajax> -->
								</p:selectOneMenu>
								
								<h:outputLabel value="Role:" for="userRole"/>
								<p:selectOneMenu value="#{userManagement.selectedRecord.userRole}" id="userRole">
									<f:selectItems value="#{referenceData.userRoles}" var="userRole" itemValue="#{userRole}" itemLabel="#{userRole.name}"/>
								</p:selectOneMenu>
				  				
				  				<h:outputLabel value="New Password:" for="newPassword/>
				  				<p:password id="newPassword" value="#{userManagement.newPassword}" feedback="true"/>
				  			</h:panelGrid>
				  		
				  		</div>
				  		<div class="w3-section">
				            <p:commandButton id="updateUser" ajax="true" action="#{userManagement.update}"
				            	oncomplete="document.getElementById('editModal').style.display='none'" value="Save"
				            	update=":form:userTable" icon="fa fa-save" style="margin-top: 5px;"/>
					  		
					  		<p:commandButton value="Cancel"
								onclick="document.getElementById('editModal').style.display='none';return false;"
								type="button" icon="fa fa-times" style="margin-left:5px;" />
				  		</div>
			  		</h:form>
		      
		     </div>
		  </div>
		
		</h:panelGroup>

		<p:confirmDialog message="Are you sure?" width="300" global="true"
			showEffect="explode" hideEffect="explode" header="Confirm"
			severity="alert" widgetVar="confirmDeleteDialogVar">
			<h:form id="deleteForm">
				<p:commandButton value="Yes" icon="fa fa-check"
					update=":form:userTable"
					action="#{userManagement.delete}"
					oncomplete="PF('confirmDeleteDialogVar').hide()" />
				<p:commandButton value="Cancel"
					onclick="PF('confirmDeleteDialogVar').hide();return false;"
					type="button" icon="fa fa-times" style="margin-left:5px;" />
			</h:form>
		</p:confirmDialog>

	</ui:define>

</ui:composition>