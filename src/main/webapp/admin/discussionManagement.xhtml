<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:pe="http://primefaces.org/ui/extensions"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:jsf="http://xmlns.jcp.org/jsf"
    template="/WEB-INF/template/layout_admin.xhtml">

	<ui:define name="title">
		#{msg['application.title']} - Discussions Management
	</ui:define>
	
	<ui:define name="content">

		<style type="text/css">	
			 
			 /* borderless datatable: https://stackoverflow.com/questions/18880208/remove-all-borders-on-a-specific-datatable */
			
			.ui-datatable.borderless thead th,
			.ui-datatable.borderless tbody,
			.ui-datatable.borderless tbody tr,
			.ui-datatable.borderless tbody td {
			    border-style: none;
			}
			
			body .ui-paginator {
				 border-style: none;
			}
			
		</style>
		
		<script type="text/javascript">
 			//<![CDATA[
 				
 				$(document).ready(function(){
					customizeDatatableStyle();
					changeAvatarBackgrounds();
				});
				
				function customizeDatatableStyle() {
					/* set datatable header's background color */
					document.querySelectorAll('.ui-datatable.borderless thead th').forEach(function(el) {el.className += ' w3-theme-l3'})
					
					/* set datatable paginator button color */
					document.querySelectorAll('span.ui-paginator-pages > a.ui-paginator-page').forEach(
						function(el) {
							el.className += ' w3-button';
							
							if(el.className.indexOf('ui-state-active') >= 0) {
								el.className += ' w3-theme-dark';	
							}
							else {
								el.className += ' w3-white';
							}
						}
					);
				}
				
				function changeAvatarBackgrounds() {
					$(".avatarSpan").each(function() {						
						$(this).css('background-color', stringToColor($(this).prop('title')));
					});
				}
				
				// from https://stackoverflow.com/questions/3426404/create-a-hexadecimal-colour-based-on-a-string-with-javascript
				function stringToColor(str) {
					var hash = 0;
					for (var i = 0; i < str.length; i++) {
						hash = str.charCodeAt(i) + ((hash << 5) - hash);
					}
					var colour = '#';
					for (var i = 0; i < 3; i++) {
						var value = (hash >> (i * 8)) & 0xFF;
					    colour += ('00' + value.toString(16)).substr(-2);
					}
					return colour;
				}				
			//]]>	
		</script>
		
		<!-- set request parameter values from URL to backing bean -->
		<f:metadata>
			<f:viewParam name="forumId" value="#{discussionManagement.forumId}"/>
			<f:viewAction action="#{discussionManagement.onLoad}"/>
		</f:metadata>
		
		<div class="w3-panel w3-card-4 w3-margin-top w3-padding w3-white" jsf:id="mainContentDiv">
		
			<p:messages id="messages" showDetail="true">
				<p:autoUpdate/>
			</p:messages>
			
			<div class="w3-center w3-margin">
 				<button class="w3-button w3-border" onclick="$('#forumMapModal').show();return false;">
 					<i class="fa fa-sitemap"/> View Forum Map
 				</button>
 			</div>
			
			<div class="w3-panel w3-round w3-theme-d5 w3-center w3-round">
 				<h2>#{msg['discussionManagement.page.title']}</h2>
 			</div>

			<h:form>
			
				<p:dataTable var="discussion" value="#{discussionManagement.lazyModel}" style="margin: 0 auto;" styleClass="borderless"
					widgetVar="discussionTableVar" rowIndexVar="rowIndex" paginator="true" sortOrder="descending"
					paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
					currentPageReportTemplate="Showing {startRecord}-{endRecord} of {totalRecords} discussions"
					rows="10" lazy="true" id="discussionTable" draggableColumns="true">
    				
					<p:ajax event="page" oncomplete="customizeDatatableStyle();changeAvatarBackgrounds();"/>
					
					<p:column sortBy="#{discussion.title}" style="text-align:left;width:33%;" priority="1">
						<f:facet name="header">
							<h:outputText value="Discussion Title" style="font-weight:bold;"/>
						</f:facet>
						
						<h:outputLink value="moderateDiscussion.xhtml?id=#{discussion.id}" title="Click to moderate this discussion">
							<span class="w3-large"><b>#{discussion.title}</b></span>
						</h:outputLink>
						<br/>
						<span>Started by <b>#{discussion.createBy} </b><pe:timeAgo value="#{discussion.createDate}" titlePattern="MMMMM dd yyyy" /></span>
					</p:column>
					
					<p:column sortBy="#{discussion.stat.commentCount}" style="text-align:center;width:120px;" priority="4">
						<f:facet name="header">
							<h:outputText value="Comments" style="font-weight:bold;"/>
						</f:facet>
						
						<span><b>#{discussion.stat.commentCount}</b></span>
						
					</p:column>

					<p:column sortBy="#{discussion.stat.viewCount}" style="text-align:center;width:120px;" priority="5">
						<f:facet name="header">
							<h:outputText value="Views" style="font-weight:bold;"/>
						</f:facet>
						
						<span><b>#{discussion.stat.viewCount}</b></span>
						
					</p:column>

					<p:column sortBy="#{discussion.createDate}" style="text-align:left;" priority="2">
						<f:facet name="header">
							<h:outputText value="Started" />
						</f:facet>
						
						<span><b>#{discussion.createDate}</b></span>
						
					</p:column>

					<p:column sortBy="#{discussion.stat.lastComment.updateDate}" style="text-align:right;" priority="3">
						<f:facet name="header">
							<h:outputText value="Last Comment" />
						</f:facet>
						
						<span>
							<pe:timeAgo value="#{discussion.stat.lastComment.updateDate}" titlePattern="MMMMM dd yyyy" />
							by <b>#{discussion.stat.lastComment.updateBy} </b>
							
							<!-- <h:graphicImage value="data:image/png;base64,#{fileHandler.getAvatarBase64(discussion.stat.lastComment.updateBy)}" class="w3-circle"
									id="commentorAvatar" height="40" width="40" style="border:3px;" title="#{discussion.stat.lastComment.updateBy}"/> -->
							<h:graphicImage value="#{requestContext}/avatar/#{discussion.stat.lastComment.updateBy}" class="w3-circle"
								id="commentorAvatar" height="30" width="30" title="#{discussion.stat.lastComment.updateBy}"
								rendered="#{fileHandler.isAvatarExists(discussion.stat.lastComment.updateBy)}"/>
															
							<span jsf:rendered="#{!fileHandler.isAvatarExists(discussion.stat.lastComment.updateBy)}" class="w3-circle avatarSpan"
								title="#{discussion.stat.lastComment.updateBy}"
 								style="display:inline-block;font-size:0.9rem;line-height:30px;width:30px;text-align:center;text-transform: uppercase;color:white">
 								#{fn:substring(discussion.stat.lastComment.updateBy, 0, 3)}
 							</span>
						</span>
					</p:column>
				
				</p:dataTable>

		    </h:form>

    		<div id="forumMapModal" class="w3-modal">
    			<div class="w3-modal-content w3-animate-zoom" jsf:id="forumMapContent">
    				<span onclick="$('#forumMapModal').hide();" class="w3-button w3-xlarge w3-transparent w3-text-white w3-display-topright" title="Close">&#215;</span>
		
					<header class="w3-container w3-padding w3-theme-dark w3-center">
						<span class="w3-xlarge"><i class="fa fa-sitemap"/> Forum Map</span>
					</header>
					
					<div class="w3-padding-large">
						<p:tree id="forumMapTree" value="#{viewForumGroup.forumRootTreeNode}" var="forumNode" style="margin: 0 auto;width:100%;">
							<p:treeNode>
								<h:link outcome="discussionManagement" rendered="#{forumNode.type eq 'Forum'}">
									<span class="w3-tag" style="line-height:36px;width:36px;height:36px;border-radius:3px;color:#fff;background-color:##{forumNode.bean.iconColor};">
					        			<i class="fa-lg #{forumNode.bean.icon}"/>
					        		</span>
					        		<span>
					        			<b>#{forumNode.bean.title}</b>
					        		</span>
					        		<f:param name="forumId" value="#{forumNode.bean.id}"/>
				        		</h:link>
				        		
				        		<h:link rendered="#{forumNode.type eq 'ForumGroup'}" outcome="forumManagement">				        	
						        	<span class="w3-large w3-opacity-min">
						        		<i class="fa fa-lg fa-sitemap"/> #{forumNode.bean.title}
						        	</span>
						        	<f:param name="forumGroupId" value="#{forumNode.bean.id}"/>
					        	</h:link>						
								
							</p:treeNode>
						</p:tree>
					</div>
					
    			</div>
    		</div>

		</div> <!-- end mainContentDiv -->

	</ui:define>
	
</ui:composition>